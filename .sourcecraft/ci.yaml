tokens:
  SERVICE_CONNECTION:
    service_connection: default-service-connection # –ò–º—è —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ SourceCraft. –ó–∞–º–µ–Ω–∏—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
    scope: org

on:
  push:
    - workflows: gatsby-deploy
      filter:
        branches: main

workflows:
  gatsby-deploy:
    env:
      DOMAIN_NAME: <<YOUR_DOMAIN_NAME>> # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: my-site.example.com)
    tasks:
      - name: gatsby-deploy
        cubes:
          # –®–ê–ì 1: –ü–æ–ª—É—á–µ–Ω–∏–µ IAM-—Ç–æ–∫–µ–Ω–∞ Yandex Cloud
          # –ö—É–±–∏–∫ –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω SourceCraft –Ω–∞ IAM-—Ç–æ–∫–µ–Ω Yandex Cloud
          # –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é IAM_TOKEN –≤ –±–ª–æ–∫–µ outputs
          - name: get-iam-token
            env:
              ID_TOKEN: ${{ tokens.SERVICE_CONNECTION.id_token }}
              YC_SA_ID: ${{ tokens.SERVICE_CONNECTION.service_account_id }}
            image: cr.yandex/sourcecraft/yc-iam:latest

          # –®–ê–ì 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞ –∫ S3 –∏–∑ Yandex Lockbox
          # –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Object Storage –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏
          - name: get-s3-keys
            image: cr.yandex/sourcecraft/yc-cli:latest
            env:
              YC_IAM_TOKEN: ${{ cubes.get-iam-token.outputs.IAM_TOKEN }}
              YC_FOLDER_ID: ${{ tokens.SERVICE_CONNECTION.folder_id }}
            script:
              - |
                echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Yandex Cloud CLI..."
                yc config set folder-id $YC_FOLDER_ID

                echo "üîç –ü–æ–∏—Å–∫ —Å–µ–∫—Ä–µ—Ç–æ–≤ –¥–ª—è –¥–æ–º–µ–Ω–∞: $DOMAIN_NAME"
                export DOMAIN_LABEL=${DOMAIN_NAME//./-}
                echo "üìã –õ–µ–π–±–ª –¥–æ–º–µ–Ω–∞: $DOMAIN_LABEL"

                echo "üîê –ü–æ–∏—Å–∫ —Å–µ–∫—Ä–µ—Ç–∞ –≤ Yandex Lockbox..."
                export SECRET_ID=$(yc lockbox secret list --jq ".[] | select(.labels[\"domain-name\"] == \"$DOMAIN_LABEL\") | .id")

                if [ -z "$SECRET_ID" ]; then
                  echo "‚ùå –°–µ–∫—Ä–µ—Ç –¥–ª—è –¥–æ–º–µ–Ω–∞ $DOMAIN_LABEL –Ω–µ –Ω–∞–π–¥–µ–Ω!"
                  exit 1
                fi

                echo "‚úÖ –ù–∞–π–¥–µ–Ω —Å–µ–∫—Ä–µ—Ç —Å ID: $SECRET_ID"

                echo "üîë –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞ –∫ S3..."
                echo "S3_ACCESS_KEY_ID=$(yc lockbox payload get --id $SECRET_ID --key access_key)" >> $SOURCECRAFT_OUTPUT
                echo "S3_SECRET_ACCESS_KEY=$(yc lockbox payload get --id $SECRET_ID --key secret_key)" >> $SOURCECRAFT_OUTPUT
                echo "‚úÖ –ö–ª—é—á–∏ S3 —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"

          # –®–ê–ì 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Node.js
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è Gatsby –ø—Ä–æ–µ–∫—Ç–∞
          - name: install-dependencies
            image: node:18-alpine
            script:
              - |
                echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Node.js..."
                npm ci
                echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

          # –®–ê–ì 4: –°–±–æ—Ä–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Gatsby —Å–∞–π—Ç–∞
          # –°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∞–π—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –µ–≥–æ –≤ Object Storage
          - name: gatsby-build-deploy
            image: node:18-alpine
            env:
              AWS_ACCESS_KEY_ID: ${{ cubes.get-s3-keys.outputs.S3_ACCESS_KEY_ID }}
              AWS_SECRET_ACCESS_KEY: ${{ cubes.get-s3-keys.outputs.S3_SECRET_ACCESS_KEY }}
              AWS_REGION: ru-central1
              AWS_ENDPOINT_URL: https://storage.yandexcloud.net
            script:
              - |
                echo "üèóÔ∏è  –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É Gatsby —Å–∞–π—Ç–∞..."

                echo "üì¶ –°–±–æ—Ä–∫–∞ —Å–∞–π—Ç–∞..."
                npm run build

                if [ $? -eq 0 ]; then
                  echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
                else
                  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ —Å–∞–π—Ç–∞"
                  exit 1
                fi

                echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ..."
                npm run deploy

                if [ $? -eq 0 ]; then
                  echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
                  echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://$DOMAIN_NAME"
                else
                  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏"
                  exit 1
                fi
